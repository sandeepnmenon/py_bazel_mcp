# Security

## Overview

bazel-mcp implements multiple layers of security to protect against malicious inputs and ensure safe execution of Bazel commands. This document describes the security measures in place and best practices for using the MCP server.

## Security Features

### 1. Input Validation and Sanitization

All user inputs are validated before being passed to Bazel commands. This prevents command injection attacks and ensures only valid Bazel syntax is executed.

#### Bazel Target Labels

Target labels are validated to match the official Bazel target format:
- Absolute targets: `//path/to:target`
- External repository targets: `@repo//path:target`
- Relative targets: `:target`
- Wildcard: `//...`

**Blocked characters:** `;`, `|`, `&`, `$`, `` ` ``, newlines, redirects (`>`, `<`), and shell metacharacters

**Example of blocked input:**
```python
# ❌ BLOCKED - Command injection attempt
"//src:app; rm -rf /"

# ✅ ALLOWED - Valid target
"//src:app"
```

#### Bazel Flags

Flags must start with `-` or `--` and contain only safe characters:
- Alphanumeric characters
- Underscores, hyphens
- Equals signs with safe values
- Paths with `/`, `:`, `.`
- Test filters with `*`, `+`

**Example:**
```python
# ✅ ALLOWED
"--config=debug"
"--test_filter=MyTest.*"
"--output_base=/tmp/bazel"

# ❌ BLOCKED
"--config=debug; rm -rf /"
```

#### Query Expressions

Bazel query expressions are validated to:
- Contain valid Bazel query patterns (`//`, `:`, or query functions)
- Not contain shell metacharacters
- Stay under 2000 characters

**Example:**
```python
# ✅ ALLOWED
"deps(//src:app)"
"kind('cc_test', //...)"

# ❌ BLOCKED
"deps(//src:app); malicious"
```

#### Runtime Arguments

Arguments passed to binaries (after `--`) are checked for:
- Shell injection patterns
- Reasonable length (max 1000 chars per arg)
- Limited quantity (max 100 args)

### 2. Resource Limits

To prevent denial-of-service attacks, the server enforces limits on:

| Input Type | Limit |
|------------|-------|
| Target label length | 500 characters |
| Flag length | 500 characters |
| Number of targets | 100 per request |
| Number of flags | 50 per request |
| Query expression length | 2000 characters |
| Runtime arguments | 100 per request |
| Runtime argument length | 1000 characters each |

### 3. Structured Output

All tool responses return structured JSON with:
- `success`: Boolean indicating if the operation succeeded
- `exit_code`: Process exit code (for build/run/test operations)
- `elapsed_seconds`: Time taken to complete the operation
- Error details for failed operations

**Example output:**
```json
{
  "success": true,
  "command": "bazel build",
  "targets": ["//src:app"],
  "exit_code": 0,
  "stdout_lines": 45,
  "stderr_lines": 2,
  "elapsed_seconds": 3.142
}
```

### 4. Error Handling

Validation errors return structured error responses:

```json
{
  "success": false,
  "error": "Validation error",
  "message": "Target contains forbidden character: ';'",
  "elapsed_seconds": 0.001
}
```

### 5. Workspace Validation

The server validates that it's running in a legitimate Bazel workspace:
- Checks for `WORKSPACE`, `WORKSPACE.bazel`, or `MODULE.bazel` files
- Exits with error code 1 if not in a valid workspace
- Prevents execution in arbitrary directories

## Security Best Practices

### For Users

1. **Run in Trusted Workspaces Only**
   - Only run the MCP server in Bazel workspaces you trust
   - Do not point the server at untrusted directories

2. **Use Least Privilege**
   - Run the server with the minimum necessary permissions
   - Avoid running as root or with elevated privileges

3. **Monitor Logs**
   - Check MCP server logs for suspicious activity
   - Watch for repeated validation errors

4. **Keep Updated**
   - Regularly update to the latest version
   - Review release notes for security fixes

### For AI Agents

1. **Validate Agent Outputs**
   - Review commands generated by AI agents before execution
   - Implement rate limiting for agent requests

2. **Scope Agent Permissions**
   - Limit which tools the agent can access
   - Use MCP's permission system to restrict operations

3. **Audit Agent Activity**
   - Log all agent-initiated commands
   - Review logs regularly for anomalies

## Threat Model

### Protected Against

✅ **Command Injection**
- Shell metacharacters in targets, flags, or arguments
- Chained commands using `;`, `|`, `&&`, `||`
- Command substitution using `` ` `` or `$()`

✅ **Path Traversal**
- While paths are allowed in some contexts, they're validated
- Dangerous patterns like `../../../` are constrained by Bazel's own validation

✅ **Denial of Service**
- Length limits prevent excessive memory usage
- Count limits prevent resource exhaustion
- Reasonable timeouts for operations

✅ **Arbitrary Code Execution**
- Only valid Bazel commands can be executed
- Runtime arguments are validated for shell injection
- No arbitrary shell access

### Not Protected Against

⚠️ **Malicious Build Rules**
- The server cannot validate BUILD file contents
- Bazel build rules can execute arbitrary code during builds
- **Mitigation:** Only use trusted Bazel workspaces

⚠️ **Repository Compromise**
- If the Bazel workspace itself is compromised, the server will execute malicious builds
- **Mitigation:** Use version control, code review, and workspace validation

⚠️ **Local Privilege Escalation**
- The server runs with the user's permissions
- **Mitigation:** Follow principle of least privilege

## Reporting Security Issues

If you discover a security vulnerability in bazel-mcp, please report it responsibly:

1. **Do Not** open a public GitHub issue
2. Email the maintainers directly (check package metadata for contact info)
3. Include:
   - Description of the vulnerability
   - Steps to reproduce
   - Potential impact
   - Suggested fix (if any)

We will acknowledge security reports within 48 hours and provide a timeline for fixes.

## References

- [Bazel Security Model](https://bazel.build/docs/security)
- [OWASP Command Injection](https://owasp.org/www-community/attacks/Command_Injection)
- [MCP Specification](https://modelcontextprotocol.io/)
